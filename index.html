<!DOCTYPE html>
<html lang="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Timeplan</title>
    <link rel="stylesheet" href="style.css">
</head>
<body>
    <div class="new-menu-container" id="new-menu-container">
        <div class="menu-dots">
            <div class="dot"></div>
            <div class="dot"></div>
            <div class="dot"></div>
        </div>
        <div class="mode-toggle" id="mode-toggle">
            <input type="range" id="mode-slider" min="0" max="2" value="1" step="1">
            <div class="mode-labels">
                <span>Lys</span>
                <span>Mørk</span>
                <span>Farge</span>
            </div>
        </div>
        <div class="edit-button" id="edit-button">Rediger</div>
    </div>

    <div class="date-time">
        <span class="clickable" id="day-display" data-changed="false"></span>&nbsp;
        <span id="date-display"></span>&nbsp;
        <span class="clickable" id="hour-display" data-changed="false"></span>:<span class="clickable" id="minute-display" data-changed="false"></span>
    </div>

    <span class="timer-toggle" id="timer-toggle">⏲</span>
    <div class="timer-panel" id="timer-panel">
        <div class="timer-circle">
            <svg viewBox="0 0 160 160">
                <circle class="circle-bg" cx="80" cy="80" r="70.3125"></circle>
                <circle class="circle-fill" cx="80" cy="80" r="70.3125"></circle>
            </svg>
        </div>
        <div id="timer-display">00:00:00</div>
        <div class="timer-input">
            <div><label>Timer:</label><input type="number" id="timer-hours" min="0" max="23"></div>
            <div><label>Minutter:</label><input type="number" id="timer-minutes" min="0" max="59"></div>
            <div><label>Sekunder:</label><input type="number" id="timer-seconds" min="0" max="59"></div>
        </div>
        <button id="timer-start">START</button>
        <div id="reset-text">Nullstill</div>
    </div>

    <div class="reset-button" id="reset-button">Tilbakestill</div>
    <div class="container" id="main-container"></div>
    <div class="timeline" id="timeline"></div>

    <div class="edit-modal" id="edit-modal">
        <input type="text" id="edit-activity-input" placeholder="Nytt aktivitetsnavn">
        <button id="save-activity">Lagre</button>
        <button id="reset-activity">Tilbakestill</button>
        <button id="cancel-edit">Avbryt</button>
    </div>

    <script>
        const schedule = {
            "Mandag": [
                { time: "08:30", activity: "ANDAKT / NORSK" },
                { time: "09:40", activity: "KRLE" },
                { time: "11:25", activity: "NORSK 6 / MATTE 7" },
                { time: "12:35", activity: "NATUR/FYS 30" },
                { time: "13:35", activity: "MATTE 6 / NORSK 7", end: "14:30" }
            ],
            "Tirsdag": [
                { time: "08:30", activity: "ANDAKT / MATTE 6 / NORSK 7" },
                { time: "09:40", activity: "SAMFUNNSFAG" },
                { time: "11:25", activity: "ENGELSK", end: "12:25" },
                { time: "12:35", activity: "FHL/FYS 15", end: "13:35" }
            ],
            "Onsdag": [
                { time: "08:30", activity: "ANDAKT / SAMFUNNSFAG" },
                { time: "09:40", activity: "ENGELSK" },
                { time: "11:25", activity: "NORSK" },
                { time: "12:35", activity: "GYM", end: "13:35" }
            ],
            "Torsdag": [
                { time: "08:30", activity: "NATUR/FYS 30" },
                { time: "09:40", activity: "M&H 6 / K&H 7" },
                { time: "11:25", activity: "M&H 6 / K&H 7" },
                { time: "12:35", activity: "K&H 6 / GYM 7" },
                { time: "13:35", activity: "K&H 6 / MATTE 7", end: "14:30" }
            ],
            "Fredag": [
                { time: "08:30", activity: "ANDAKT / NORSK 6 / MATTE 7" },
                { time: "09:40", activity: "MATTE 6 / NORSK 7" },
                { time: "11:25", activity: "MUSIKK" },
                { time: "12:35", activity: "MUSIKK" },
                { time: "13:35", activity: "KRLE", end: "14:30" }
            ]
        };

        const breaks = {
            "Mandag": [
                { time: "09:30", activity: "Pause", end: "09:40" },
                { time: "10:40", activity: "Matpause", end: "10:55" },
                { time: "10:55", activity: "Storefri", end: "11:25" },
                { time: "12:25", activity: "Pause", end: "12:35" }
            ],
            "Tirsdag": [
                { time: "09:30", activity: "Pause", end: "09:40" },
                { time: "10:40", activity: "Matpause", end: "10:55" },
                { time: "10:55", activity: "Storefri", end: "11:25" },
                { time: "12:25", activity: "Pause", end: "12:35" }
            ],
            "Onsdag": [
                { time: "09:30", activity: "Pause", end: "09:40" },
                { time: "10:40", activity: "Matpause", end: "10:55" },
                { time: "10:55", activity: "Storefri", end: "11:25" },
                { time: "12:25", activity: "Pause", end: "12:35" }
            ],
            "Torsdag": [
                { time: "09:30", activity: "Pause", end: "09:40" },
                { time: "10:40", activity: "Matpause", end: "10:55" },
                { time: "10:55", activity: "Storefri", end: "11:25" },
                { time: "12:25", activity: "Pause", end: "12:35" }
            ],
            "Fredag": [
                { time: "09:30", activity: "Pause", end: "09:40" },
                { time: "10:40", activity: "Matpause", end: "10:55" },
                { time: "10:55", activity: "Storefri", end: "11:25" },
                { time: "12:25", activity: "Pause", end: "12:35" }
            ]
        };

        let tempScheduleChanges = JSON.parse(sessionStorage.getItem('tempScheduleChanges') || '{}');
        const todayDate = new Date().toISOString().split('T')[0];

        if (tempScheduleChanges.date !== todayDate) {
            tempScheduleChanges = { date: todayDate, changes: {} };
            sessionStorage.setItem('tempScheduleChanges', JSON.stringify(tempScheduleChanges));
        }

        let editPermission = false;
        let editPermissionTimeout = null;

        function getMinutesFromTime(timeStr) {
            const [hours, minutes] = timeStr.split(":").map(Number);
            return hours * 60 + minutes;
        }

        function getOsloTimeAndDay() {
            const now = new Date();
            const utcHours = now.getUTCHours();
            const utcMinutes = now.getUTCMinutes();
            const osloOffset = 1;
            let osloHours = (utcHours + osloOffset) % 24;
            if (osloHours < 0) osloHours += 24;
            const realOsloTime = `${osloHours.toString().padStart(2, '0')}:${utcMinutes.toString().padStart(2, '0')}`;
            let realDay = new Intl.DateTimeFormat('no-NO', { 
                weekday: 'long', 
                timeZone: 'Europe/Oslo' 
            }).format(now);
            realDay = realDay.charAt(0).toUpperCase() + realDay.slice(1).toLowerCase();

            const dayDisplay = document.getElementById("day-display") || { textContent: realDay };
            const hourDisplay = document.getElementById("hour-display") || { textContent: realOsloTime.split(':')[0] };
            const minuteDisplay = document.getElementById("minute-display") || { textContent: realOsloTime.split(':')[1] };
            const osloTime = hourDisplay.textContent && minuteDisplay.textContent ? 
                `${hourDisplay.textContent}:${minuteDisplay.textContent}` : realOsloTime;

            return { osloTime, currentDay: dayDisplay.textContent || realDay, realDay, realOsloTime };
        }

        let lastTimelineState = null;

        function createTimeline(todaySchedule, breakSchedule, currentMinutes, useRealTime) {
            const timeline = document.getElementById("timeline");
            const { currentDay } = getOsloTimeAndDay();
            const schoolDayDuration = ["Mandag", "Torsdag", "Fredag"].includes(currentDay) ? 360 : 305;
            const schoolDayStart = getMinutesFromTime("08:30");
            const schoolDayEnd = schoolDayStart + schoolDayDuration;

            const events = [...todaySchedule.map(e => ({ ...e, type: "class" }))];
            breakSchedule.forEach(breakEvent => {
                if (getMinutesFromTime(breakEvent.time) < schoolDayEnd) {
                    events.push({ ...breakEvent, type: "break" });
                }
            });
            events.sort((a, b) => getMinutesFromTime(a.time) - getMinutesFromTime(b.time));

            const colorMap = {
                "ANDAKT / NORSK": "#ff4500",
                "KRLE": "#00cc00",
                "NORSK 6 / MATTE 7": "#0000cc",
                "NATUR/FYS 30": "#cc00cc",
                "MATTE 6 / NORSK 7": "#cccc00",
                "ANDAKT / MATTE 6 / NORSK 7": "#cccc00",
                "SAMFUNNSFAG": "#00cccc",
                "ENGELSK": "#ff69b4",
                "FHL/FYS 15": "#9400d3",
                "GYM": "#ff8c00",
                "M&H 6 / K&H 7": "#00b7eb",
                "K&H 6 / GYM 7": "#ff4500",
                "K&H 6 / MATTE 7": "#99cc00",
                "MUSIKK": "#6a0dad",
                "Pause": "#ffffff",
                "Matpause": "#ffffff",
                "Storefri": "#ffffff"
            };

            const timelineState = JSON.stringify({
                events: events.map(e => ({
                    time: e.time,
                    activity: tempScheduleChanges.changes[`${currentDay}-${e.time}`] || e.activity,
                    end: e.end,
                    type: e.type
                })),
                currentMinutes,
                useRealTime
            });

            if (lastTimelineState !== timelineState || document.body.dataset.lastMode !== modeSlider.value) {
                lastTimelineState = timelineState;
                document.body.dataset.lastMode = modeSlider.value;
                timeline.innerHTML = '<div class="marker" id="marker"></div>';

                let activeHoverBox = null;
                let hoverTimeout = null;

                events.forEach((event, index) => {
                    const startTime = getMinutesFromTime(event.time);
                    let endTime = event.end ? getMinutesFromTime(event.end) : 
                        (index + 1 < events.length ? getMinutesFromTime(events[index + 1].time) : schoolDayEnd);
                    const duration = endTime - startTime;
                    const widthPercent = (duration / schoolDayDuration) * 100;
                    const leftPercent = ((startTime - schoolDayStart) / schoolDayDuration) * 100;

                    const box = document.createElement("div");
                    box.className = `event-box ${event.type === "break" ? "break" : ""} ${editPermission ? "editable" : ""}`;
                    box.style.width = `calc(${widthPercent}% - 2px)`;
                    box.style.left = `${leftPercent}%`;

                    const eventKey = `${currentDay}-${event.time}`;
                    const tempActivity = tempScheduleChanges.changes[eventKey];
                    const originalActivity = event.activity;
                    const displayActivity = tempActivity || originalActivity;
                    box.textContent = displayActivity;

                    if (document.body.classList.contains('colorful-mode')) {
                        box.style.backgroundColor = colorMap[originalActivity] || "#ffffff";
                    } else if (document.body.classList.contains('light-mode')) {
                        box.style.backgroundColor = event.type === "break" ? "#bbb" : "#ddd";
                        if (currentMinutes >= startTime && currentMinutes < endTime) {
                            box.style.backgroundColor = "#fff";
                        }
                    } else {
                        box.style.backgroundColor = event.type === "break" ? "#777" : "#555";
                        if (currentMinutes >= startTime && currentMinutes < endTime) {
                            box.style.backgroundColor = "#ddd";
                        }
                    }

                    if (currentMinutes >= startTime && currentMinutes < endTime) {
                        box.classList.add("active");
                    }

                    const hoverBox = document.createElement("div");
                    hoverBox.className = "hover-box";
                    hoverBox.innerHTML = `
                        <div class="activity-name">${displayActivity}</div>
                        <div class="time">${event.time}-${event.end || events[index + 1]?.time || "14:30"}</div>
                        <div class="teacher">Lærer: (TBA)</div>
                    `;
                    timeline.appendChild(hoverBox);

                    box.addEventListener("mouseenter", () => {
                        if (activeHoverBox) {
                            activeHoverBox.classList.remove("active");
                            clearTimeout(hoverTimeout);
                        }
                        const boxRect = box.getBoundingClientRect();
                        const timelineRect = timeline.getBoundingClientRect();
                        const leftPosition = boxRect.left - timelineRect.left + (boxRect.width * 1.05 / 2);
                        hoverBox.style.left = `${leftPosition}px`;
                        hoverBox.style.transform = "translateX(-50%)";
                        hoverTimeout = setTimeout(() => {
                            if (box.matches(':hover')) {
                                hoverBox.classList.add("active");
                                activeHoverBox = hoverBox;
                            }
                        }, 300);
                    });

                    box.addEventListener("mouseleave", () => {
                        clearTimeout(hoverTimeout);
                        hoverBox.classList.remove("active");
                        activeHoverBox = null;
                    });

                    if (editPermission) {
                        box.addEventListener("click", () => {
                            const modal = document.getElementById("edit-modal");
                            const input = document.getElementById("edit-activity-input");
                            const resetButton = document.getElementById("reset-activity");
                            input.value = displayActivity;
                            modal.classList.add("active");

                            resetButton.style.display = tempActivity ? "block" : "none";

                            const saveButton = document.getElementById("save-activity");
                            const cancelButton = document.getElementById("cancel-edit");

                            const saveHandler = () => {
                                const newActivity = input.value.trim();
                                if (newActivity) {
                                    tempScheduleChanges.changes[eventKey] = newActivity;
                                    sessionStorage.setItem('tempScheduleChanges', JSON.stringify(tempScheduleChanges));
                                    updateActivityAndCountdown();
                                }
                                modal.classList.remove("active");
                                saveButton.removeEventListener("click", saveHandler);
                            };

                            const resetHandler = () => {
                                delete tempScheduleChanges.changes[eventKey];
                                sessionStorage.setItem('tempScheduleChanges', JSON.stringify(tempScheduleChanges));
                                updateActivityAndCountdown();
                                modal.classList.remove("active");
                                resetButton.removeEventListener("click", resetHandler);
                            };

                            const cancelHandler = () => {
                                modal.classList.remove("active");
                                cancelButton.removeEventListener("click", cancelHandler);
                            };

                            saveButton.addEventListener("click", saveHandler);
                            resetButton.addEventListener("click", resetHandler);
                            cancelButton.addEventListener("click", cancelHandler);
                        });
                    }

                    timeline.appendChild(box);
                });

                const marker = document.getElementById("marker");
                const markerTime = useRealTime ? getMinutesFromTime(getOsloTimeAndDay().realOsloTime) : currentMinutes;
                let markerPosition = markerTime < schoolDayStart ? 0 : 
                    markerTime >= schoolDayEnd ? 100 : ((markerTime - schoolDayStart) / schoolDayDuration) * 100;
                marker.style.left = `${markerPosition}%`;
            } else {
                const marker = document.getElementById("marker");
                if (marker) {
                    const markerTime = useRealTime ? getMinutesFromTime(getOsloTimeAndDay().realOsloTime) : currentMinutes;
                    let markerPosition = markerTime < schoolDayStart ? 0 : 
                        markerTime >= schoolDayEnd ? 100 : ((markerTime - schoolDayStart) / schoolDayDuration) * 100;
                    marker.style.left = `${markerPosition}%`;
                }
            }
        }

        function updateActivityAndCountdown() {
            const { osloTime, currentDay, realDay, realOsloTime } = getOsloTimeAndDay();
            const dayDisplay = document.getElementById("day-display");
            const hourDisplay = document.getElementById("hour-display");
            const minuteDisplay = document.getElementById("minute-display");

            const useRealTime = dayDisplay.dataset.changed === "false" && 
                                hourDisplay.dataset.changed === "false" && 
                                minuteDisplay.dataset.changed === "false";
            const currentTime = useRealTime ? realOsloTime : osloTime;
            const currentMinutes = getMinutesFromTime(currentTime);

            let todaySchedule = schedule[currentDay] || [];
            let breakSchedule = breaks[currentDay] || [];
            let currentActivity = "FRI";
            let countdownText = "";
            const firstClassTime = todaySchedule.length ? getMinutesFromTime(todaySchedule[0].time) : 24 * 60;
            const schoolDayDuration = ["Mandag", "Torsdag", "Fredag"].includes(currentDay) ? 360 : 305;
            const schoolDayEnd = todaySchedule.length ? getMinutesFromTime(todaySchedule[0].time) + schoolDayDuration : 24 * 60;

            const resetButton = document.getElementById("reset-button");
            const isDifferent = (dayDisplay.dataset.changed === "true" || 
                                hourDisplay.dataset.changed === "true" || 
                                minuteDisplay.dataset.changed === "true") && 
                                (currentDay !== realDay || currentTime !== realOsloTime);
            resetButton.style.display = isDifferent ? "block" : "none";

            if (dayDisplay && currentDay) dayDisplay.textContent = currentDay;
            if (hourDisplay && minuteDisplay && currentTime) {
                const [hours, minutes] = currentTime.split(':');
                hourDisplay.textContent = hours;
                minuteDisplay.textContent = minutes;
            }

            const now = new Date();
            const realDayOfWeek = now.getDay();
            const isRealWeekend = realDayOfWeek === 0 || realDayOfWeek === 6;
            if (useRealTime && isRealWeekend) {
                document.getElementById("main-container").innerHTML = '<div id="current-activity" class="bold">Ha en fantastisk helg!</div>';
                document.getElementById("timeline").style.display = "none";
                return;
            }

            for (let i = 0; i < todaySchedule.length; i++) {
                const startTime = getMinutesFromTime(todaySchedule[i].time);
                const endTime = todaySchedule[i].end ? getMinutesFromTime(todaySchedule[i].end) : 
                    (i + 1 < todaySchedule.length ? getMinutesFromTime(todaySchedule[i + 1].time) : schoolDayEnd);
                if (currentMinutes >= startTime && currentMinutes < endTime) {
                    const eventKey = `${currentDay}-${todaySchedule[i].time}`;
                    currentActivity = tempScheduleChanges.changes[eventKey] || todaySchedule[i].activity;
                    break;
                }
            }

            for (let breakEvent of breakSchedule) {
                const startTime = getMinutesFromTime(breakEvent.time);
                const endTime = getMinutesFromTime(breakEvent.end);
                if (currentMinutes >= startTime && currentMinutes < endTime) {
                    currentActivity = breakEvent.activity;
                    break;
                }
            }

            if (currentMinutes >= schoolDayEnd) {
                document.getElementById("main-container").innerHTML = currentDay === "Fredag" ?
                    '<div id="current-activity" class="bold">Ha en fantastisk helg!</div>' :
                    '<div id="current-activity" class="bold">Skoledagen er over!\nNyt dagen!</div>';
                document.getElementById("timeline").style.display = "flex";
                createTimeline(todaySchedule, breakSchedule, currentMinutes, useRealTime);
                return;
            } else if (currentMinutes < firstClassTime) {
                document.getElementById("main-container").innerHTML = `
                    <div class="thin" id="label">Skoledagen begynner om</div>
                    <div id="current-activity" class="bold"></div>
                    <div class="thin countdown" id="countdown-container">${firstClassTime - currentMinutes} min.</div>`;
                document.getElementById("timeline").style.display = "flex";
                createTimeline(todaySchedule, breakSchedule, currentMinutes, useRealTime);
                return;
            } else {
                document.getElementById("main-container").innerHTML = `
                    <div class="thin" id="label">Akkurat nå:</div>
                    <div id="current-activity" class="bold">${currentActivity}</div>
                    <div class="thin countdown" id="countdown-container"></div>`;
                document.getElementById("timeline").style.display = "flex";
            }

            let nextEventTime = null;
            let isNextBreak = false;

            if (["Pause", "Matpause", "Storefri"].includes(currentActivity)) {
                for (let i = 0; i < todaySchedule.length; i++) {
                    const classTime = getMinutesFromTime(todaySchedule[i].time);
                    if (currentMinutes < classTime && classTime < schoolDayEnd && (!nextEventTime || classTime < nextEventTime)) {
                        nextEventTime = classTime;
                        isNextBreak = false;
                    }
                }
                countdownText = nextEventTime ? 
                    `Neste time om ${nextEventTime - currentMinutes} min.` : 
                    "Ingen flere timer i dag.";
            } else {
                for (let breakEvent of breakSchedule) {
                    const breakStart = getMinutesFromTime(breakEvent.time);
                    if (currentMinutes < breakStart && breakStart < schoolDayEnd && (!nextEventTime || breakStart < nextEventTime)) {
                        nextEventTime = breakStart;
                        isNextBreak = true;
                    }
                }
                if (!nextEventTime && currentMinutes < schoolDayEnd) {
                    for (let i = 0; i < todaySchedule.length; i++) {
                        const classTime = getMinutesFromTime(todaySchedule[i].time);
                        if (currentMinutes < classTime && classTime <= schoolDayEnd && (!nextEventTime || classTime < nextEventTime)) {
                            nextEventTime = classTime;
                            isNextBreak = false;
                        }
                    }
                }
                if (nextEventTime) {
                    const minutesLeft = nextEventTime - currentMinutes;
                    const isLastActivity = todaySchedule.length && todaySchedule[todaySchedule.length - 1].activity === currentActivity && 
                                          currentMinutes >= getMinutesFromTime(todaySchedule[todaySchedule.length - 1].time);
                    countdownText = isLastActivity ? 
                        (currentDay === "Fredag" ? `Det er helg om ${minutesLeft} min.` : `Skoledagen er over om ${minutesLeft} min.`) :
                        (isNextBreak ? `Neste pause om ${minutesLeft} min.` : `Neste time om ${minutesLeft} min.`);
                } else if (todaySchedule.length && todaySchedule[todaySchedule.length - 1].activity === currentActivity && 
                           currentMinutes >= getMinutesFromTime(todaySchedule[todaySchedule.length - 1].time)) {
                    const minutesLeft = schoolDayEnd - currentMinutes;
                    countdownText = currentDay === "Fredag" ? `Det er helg om ${minutesLeft} min.` : `Skoledagen er over om ${minutesLeft} min.`;
                }
            }

            document.getElementById("countdown-container").textContent = countdownText;
            createTimeline(todaySchedule, breakSchedule, currentMinutes, useRealTime);
        }

        function updateDateTime() {
            const { osloTime, currentDay, realDay, realOsloTime } = getOsloTimeAndDay();
            if (!realOsloTime || !realDay) return;

            const dayDisplay = document.getElementById("day-display");
            const dateElement = document.getElementById("date-display");
            const hourDisplay = document.getElementById("hour-display");
            const minuteDisplay = document.getElementById("minute-display");

            if (dayDisplay && dateElement && hourDisplay && minuteDisplay) {
                const now = new Date();
                const osloFormatter = new Intl.DateTimeFormat('no-NO', {
                    day: 'numeric',
                    month: 'long',
                    timeZone: 'Europe/Oslo'
                });
                const parts = osloFormatter.formatToParts(now);
                const day = parts.find(p => p.type === 'day').value;
                const month = parts.find(p => p.type === 'month').value;
                dayDisplay.textContent = currentDay || realDay;
                dateElement.textContent = `${day}. ${month}`;
                const useRealTime = dayDisplay.dataset.changed === "false" && 
                                    hourDisplay.dataset.changed === "false" && 
                                    minuteDisplay.dataset.changed === "false";
                if (useRealTime) {
                    const [hours, minutes] = realOsloTime.split(':');
                    hourDisplay.textContent = hours;
                    minuteDisplay.textContent = minutes;
                }
            }
        }

        function resetToRealTime() {
            const { realDay, realOsloTime } = getOsloTimeAndDay();
            const dayDisplay = document.getElementById("day-display");
            const hourDisplay = document.getElementById("hour-display");
            const minuteDisplay = document.getElementById("minute-display");
            dayDisplay.textContent = realDay;
            const [realHour, realMinute] = realOsloTime.split(':');
            hourDisplay.textContent = realHour;
            minuteDisplay.textContent = (Math.round(parseInt(realMinute) / 5) * 5).toString().padStart(2, '0');
            dayDisplay.dataset.changed = "false";
            hourDisplay.dataset.changed = "false";
            minuteDisplay.dataset.changed = "false";
            updateActivityAndCountdown();
            updateDateTime();
        }

        function createDropdown(elementId, options, onChange) {
            const displayElement = document.getElementById(elementId + "-display");
            const dropdown = document.createElement("div");
            dropdown.className = `dropdown-list ${elementId}-dropdown`; // Legg til unik klasse
            dropdown.id = elementId + "-dropdown";

            options.forEach(option => {
                const button = document.createElement("button");
                button.textContent = option;
                button.addEventListener("click", () => {
                    onChange(option);
                    displayElement.textContent = option;
                    displayElement.dataset.changed = "true";
                    dropdown.classList.remove("show");
                    updateActivityAndCountdown();
                    updateDateTime();
                });
                dropdown.appendChild(button);
            });

            displayElement.parentNode.appendChild(dropdown);
            displayElement.addEventListener("click", (e) => {
                e.stopPropagation();
                dropdown.classList.toggle("show");
            });
        }

        function activateEditPermission() {
            editPermission = true;
            clearTimeout(editPermissionTimeout);
            editPermissionTimeout = setTimeout(() => {
                editPermission = false;
                updateActivityAndCountdown();
            }, 3 * 60 * 1000); // 3 minutter
            lastTimelineState = null;
            updateActivityAndCountdown();
        }

        // Deklarasjoner
        const newMenuContainer = document.getElementById('new-menu-container');
        const modeToggle = document.getElementById('mode-toggle');
        const modeSlider = document.getElementById('mode-slider');
        const editButton = document.getElementById('edit-button');
        const timerToggle = document.getElementById('timer-toggle');
        const timerPanel = document.getElementById('timer-panel');
        const timerHours = document.getElementById('timer-hours');
        const timerMinutes = document.getElementById('timer-minutes');
        const timerSeconds = document.getElementById('timer-seconds');
        const timerStart = document.getElementById('timer-start');
        const circleFill = document.querySelector('.timer-circle .circle-fill');
        const timerDisplay = document.getElementById('timer-display');
        const resetText = document.getElementById('reset-text');
        let timerInterval;
        let totalTime = 0;
        let remainingTime = 0;
        let isPaused = false;
        let hideTimeout;

        // Timer-logikk
        timerPanel.addEventListener('transitionend', () => {
            if (timerPanel.classList.contains('active') && !timerInterval) {
                const circumference = 2 * Math.PI * 70.3125;
                circleFill.style.strokeDasharray = `${circumference} ${circumference}`;
                circleFill.style.strokeDashoffset = circumference;
                timerStart.textContent = 'START';
                resetText.style.display = 'none';
            }
        });

        timerToggle.addEventListener('click', () => {
            timerPanel.classList.toggle('active');
            if (!timerPanel.classList.contains('active') && timerInterval) {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.textContent = "00:00:00";
            }
        });

        timerStart.addEventListener('click', () => {
            const hours = parseInt(timerHours.value) || 0;
            const minutes = parseInt(timerMinutes.value) || 0;
            const seconds = parseInt(timerSeconds.value) || 0;

            totalTime = (hours * 3600) + (minutes * 60) + seconds;

            if (totalTime > 0) {
                if (!timerInterval) {
                    remainingTime = totalTime;
                    const circumference = 2 * Math.PI * 70.3125;
                    circleFill.style.strokeDasharray = `${circumference} ${circumference}`;
                    circleFill.style.strokeDashoffset = circumference;
                    updateTimerDisplay();
                    timerInterval = setInterval(updateTimer, 1000);
                    timerStart.textContent = 'PAUSE';
                    resetText.style.display = 'none';
                } else if (!isPaused) {
                    clearInterval(timerInterval);
                    timerInterval = null;
                    isPaused = true;
                    timerStart.textContent = 'START';
                    resetText.style.display = 'block';
                } else {
                    isPaused = false;
                    timerInterval = setInterval(updateTimer, 1000);
                    timerStart.textContent = 'PAUSE';
                    resetText.style.display = 'none';
                }
            }
        });

        resetText.addEventListener('click', () => {
            if (timerInterval) clearInterval(timerInterval);
            timerInterval = null;
            remainingTime = 0;
            totalTime = 0;
            const circumference = 2 * Math.PI * 70.3125;
            circleFill.style.strokeDashoffset = circumference;
            timerDisplay.textContent = "00:00:00";
            timerStart.textContent = 'START';
            resetText.style.display = 'none';
        });

        function updateTimer() {
            if (remainingTime > 0) {
                remainingTime--;
                updateTimerDisplay();
            } else {
                clearInterval(timerInterval);
                timerInterval = null;
                timerDisplay.textContent = "00:00:00";
                const circumference = 2 * Math.PI * 70.3125;
                circleFill.style.strokeDashoffset = circumference;
                timerStart.textContent = 'START';
                resetText.style.display = 'block';
            }
        }

        function updateTimerDisplay() {
            const hours = Math.floor(remainingTime / 3600);
            const minutes = Math.floor((remainingTime % 3600) / 60);
            const seconds = remainingTime % 60;
            timerDisplay.textContent = `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;

            const circumference = 2 * Math.PI * 70.3125;
            const progress = ((totalTime - remainingTime) / totalTime) * circumference;
            circleFill.style.strokeDashoffset = circumference - progress;
        }

        // Meny-logikk
        newMenuContainer.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
            modeToggle.style.opacity = '1';
            modeToggle.style.visibility = 'visible';
            modeToggle.style.top = getComputedStyle(document.documentElement).getPropertyValue('--mode-toggle-visible-top');
            editButton.style.opacity = '1';
            editButton.style.visibility = 'visible';
            editButton.style.top = getComputedStyle(document.documentElement).getPropertyValue('--edit-button-visible-top');
        });

        newMenuContainer.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                if (!modeToggle.matches(':hover') && !editButton.matches(':hover')) {
                    modeToggle.style.opacity = '0';
                    modeToggle.style.visibility = 'hidden';
                    modeToggle.style.top = getComputedStyle(document.documentElement).getPropertyValue('--mode-toggle-hidden-top');
                    editButton.style.opacity = '0';
                    editButton.style.visibility = 'hidden';
                    editButton.style.top = getComputedStyle(document.documentElement).getPropertyValue('--edit-button-hidden-top');
                }
            }, 4000);
        });

        modeToggle.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
        });

        modeToggle.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                if (!newMenuContainer.matches(':hover') && !editButton.matches(':hover')) {
                    modeToggle.style.opacity = '0';
                    modeToggle.style.visibility = 'hidden';
                    modeToggle.style.top = getComputedStyle(document.documentElement).getPropertyValue('--mode-toggle-hidden-top');
                    editButton.style.opacity = '0';
                    editButton.style.visibility = 'hidden';
                    editButton.style.top = getComputedStyle(document.documentElement).getPropertyValue('--edit-button-hidden-top');
                }
            }, 4000);
        });

        editButton.addEventListener('mouseenter', () => {
            clearTimeout(hideTimeout);
        });

        editButton.addEventListener('mouseleave', () => {
            hideTimeout = setTimeout(() => {
                if (!newMenuContainer.matches(':hover') && !modeToggle.matches(':hover')) {
                    modeToggle.style.opacity = '0';
                    modeToggle.style.visibility = 'hidden';
                    modeToggle.style.top = getComputedStyle(document.documentElement).getPropertyValue('--mode-toggle-hidden-top');
                    editButton.style.opacity = '0';
                    editButton.style.visibility = 'hidden';
                    editButton.style.top = getComputedStyle(document.documentElement).getPropertyValue('--edit-button-hidden-top');
                }
            }, 4000);
        });

        editButton.addEventListener('click', () => {
            activateEditPermission();
        });

        modeSlider.addEventListener('input', () => {
            const value = modeSlider.value;
            document.body.classList.remove('light-mode', 'colorful-mode');
            if (value == 0) {
                document.body.classList.add('light-mode');
            } else if (value == 1) {
                // Mørk modus (default)
            } else if (value == 2) {
                document.body.classList.add('colorful-mode');
            }
            lastTimelineState = null;
            updateActivityAndCountdown();
        });

        // Sett default til mørk modus
        modeSlider.value = 1;

        // Andre event listeners
        document.addEventListener("click", (event) => {
            if (!event.target.matches('.clickable') && !event.target.matches('.dropdown-list button')) {
                document.querySelectorAll(".dropdown-list.show").forEach(dropdown => {
                    dropdown.classList.remove("show");
                });
            }
        });

        document.getElementById("reset-button").addEventListener("click", resetToRealTime);

        createDropdown("day", Object.keys(schedule), (selectedDay) => {
            document.getElementById("day-display").textContent = selectedDay;
        });

        createDropdown("hour", Array.from({ length: 24 }, (_, i) => i.toString().padStart(2, '0')), (selectedHour) => {
            document.getElementById("hour-display").textContent = selectedHour;
        });

        createDropdown("minute", Array.from({ length: 12 }, (_, i) => (i * 5).toString().padStart(2, '0')), (selectedMinute) => {
            document.getElementById("minute-display").textContent = selectedMinute;
        });

        // Initialisering
        const { realDay, realOsloTime } = getOsloTimeAndDay();
        document.getElementById("day-display").textContent = realDay;
        const [realHour, realMinute] = realOsloTime.split(':');
        document.getElementById("hour-display").textContent = realHour;
        document.getElementById("minute-display").textContent = (Math.round(parseInt(realMinute) / 5) * 5).toString().padStart(2, '0');
        document.getElementById("day-display").dataset.changed = "false";
        document.getElementById("hour-display").dataset.changed = "false";
        document.getElementById("minute-display").dataset.changed = "false";

        setInterval(updateActivityAndCountdown, 1000);
        setInterval(updateDateTime, 1000);
        updateActivityAndCountdown();
        updateDateTime();
    </script>
</body>
</html>